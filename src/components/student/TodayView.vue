<style scoped>
/* ä»Šæ—¥äº‹é¡¹è§†å›¾ */
.today-view {
  padding: 20px 24px;
}

/* å¿«é€Ÿå­¦ä¹ å¡ç‰‡ */
.quick-learning-card {
  margin-bottom: 20px;
  padding: 20px;
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border-radius: 12px;
}

.quick-learning-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.quick-learning-title {
  font-weight: 700;
  color: #0369a1;
  font-size: 16px;
}

.quick-learning-buttons {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.quick-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 12px 20px;
  font-size: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}

.quick-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.quick-btn-primary {
  background: var(--primary-color);
  color: white;
}

.quick-btn-success {
  background: #22c55e;
  color: white;
}

.quick-btn-warning {
  background: #f59e0b;
  color: white;
}

/* ä»Šæ—¥äº‹é¡¹ä¸»å¡ç‰‡ */
.today-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
}

.today-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
}

.today-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.today-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.today-datetime {
  color: #6b7280;
  font-size: 14px;
}

.today-content {
  display: grid;
  grid-template-columns: 3fr 2fr;
  gap: 24px;
  padding: 20px;
}

/* ä»Šæ—¥è¯¾ç¨‹ */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
}

.section-link {
  color: var(--primary-color);
  text-decoration: none;
  font-size: 12px;
  cursor: pointer;
}

.section-link:hover {
  text-decoration: underline;
}

.course-timeline {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.course-item {
  display: flex;
  gap: 16px;
  padding: 16px;
  border-radius: 10px;
  border-left: 4px solid #e5e7eb;
  background: #fafafa;
  transition: all 0.2s ease;
}

.course-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transform: translateX(2px);
}

.course-item.completed {
  border-left-color: #22c55e;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.course-item.current {
  border-left-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.course-item.upcoming {
  border-left-color: #3b82f6;
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
}

.course-time {
  min-width: 100px;
  font-weight: 600;
  color: #1f2937;
  font-size: 14px;
}

.course-info {
  flex: 1;
}

.course-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.course-name {
  font-weight: 600;
  color: #1f2937;
  font-size: 15px;
}

.course-status {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
}

.course-status.done {
  background: #22c55e;
  color: white;
}

.course-status.ongoing {
  background: #f59e0b;
  color: white;
}

.course-status.coming {
  background: #3b82f6;
  color: white;
}

.course-details {
  display: flex;
  gap: 12px;
  color: #6b7280;
  font-size: 12px;
}

/* å¾…åŠäº‹é¡¹ */
.todo-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.todo-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border-radius: 8px;
  background: #fff;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
}

.todo-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.todo-item.urgent {
  border-left: 4px solid #3b82f6;
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
}

.todo-item.normal {
  border-left: 4px solid #3b82f6;
}

.todo-item.overdue {
  border-left: 4px solid #dc2626;
  background: linear-gradient(135deg, #fef2f2, #fecaca);
}

.todo-item.completed {
  background: #f9fafb;
  opacity: 0.7;
}

.todo-item.completed .todo-label {
  text-decoration: line-through;
  color: #6b7280;
}

.todo-item.overdue .todo-label {
  color: #991b1b;
}

.todo-checkbox {
  cursor: pointer;
}

.todo-checkbox:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.todo-label {
  flex: 1;
  font-size: 14px;
  color: #1f2937;
}

.todo-deadline {
  font-size: 11px;
  color: #6b7280;
  white-space: nowrap;
}

.todo-item.urgent .todo-deadline {
  color: #2563eb;
  font-weight: 600;
}

.todo-item.overdue .todo-deadline {
  color: #dc2626;
  font-weight: 600;
}

/* å“åº”å¼ */
@media (max-width: 1200px) {
  .today-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
}

@media (max-width: 860px) {
  .today-view {
    padding: 16px;
  }

  .today-content {
    padding: 16px;
    gap: 16px;
  }

  .course-item {
    padding: 12px;
  }

  .todo-item {
    padding: 10px;
  }

  .quick-learning-buttons {
    flex-direction: column;
    gap: 12px;
  }

  .quick-btn {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script setup>
import { ref, inject, onMounted, computed } from 'vue';
import { ElMessage } from 'element-plus';

const switchView = inject('switchView');

// å½“å‰æ—¥æœŸæ—¶é—´
const currentDateTime = ref('');

const updateDateTime = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const date = now.getDate();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const weekdays = [
    'æ˜ŸæœŸæ—¥',
    'æ˜ŸæœŸä¸€',
    'æ˜ŸæœŸäºŒ',
    'æ˜ŸæœŸä¸‰',
    'æ˜ŸæœŸå››',
    'æ˜ŸæœŸäº”',
    'æ˜ŸæœŸå…­',
  ];
  const weekday = weekdays[now.getDay()];
  currentDateTime.value = `${year}å¹´${month}æœˆ${date}æ—¥${weekday} ${hours}:${minutes}`;
};

onMounted(() => {
  updateDateTime();
  setInterval(updateDateTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°
});

// ==================== ğŸ”´ æ¨¡æ‹Ÿæ•°æ® START ====================
// TODO: åç»­éœ€è¦ä»åç«¯APIè·å–çœŸå®æ•°æ®
// APIæ¥å£: GET /api/student/today-schedule
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šclass_session, edu_course, sys_user, edu_classroom

// ä»Šæ—¥è¯¾ç¨‹
const todayCourses = ref([
  {
    session_id: 3001, // class_session.session_id
    course_id: 601, // edu_course.course_id
    course_name: 'é«˜ç­‰æ•°å­¦', // edu_course.course_name
    teacher_id: 211, // edu_teacher.teacher_id
    teacher_name: 'ç‹è€å¸ˆ', // sys_user.real_name
    classroom_id: 301, // edu_classroom.classroom_id
    classroom_name: 'æ•°å­¦æ¥¼A301', // edu_classroom.building + classroom_name
    start_time: '2025-01-15 08:00:00', // class_session.start_timeï¼ˆDATETIMEï¼‰
    end_time: '2025-01-15 09:40:00', // class_session.end_timeï¼ˆDATETIMEï¼‰
    status: 'ENDED', // class_session.statusï¼ˆENUM: 'NOT_STARTED','ONGOING','ENDED'ï¼‰
  },
  {
    session_id: 3002,
    course_id: 604,
    course_name: 'çº¿æ€§ä»£æ•°',
    teacher_id: 214,
    teacher_name: 'æè€å¸ˆ',
    classroom_id: 302,
    classroom_name: 'æ•°å­¦æ¥¼B205',
    start_time: '2025-01-15 10:00:00',
    end_time: '2025-01-15 11:40:00',
    status: 'ONGOING',
  },
  {
    session_id: 3003,
    course_id: 611,
    course_name: 'æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡',
    teacher_id: 221,
    teacher_name: 'å¼ è€å¸ˆ',
    classroom_id: 303,
    classroom_name: 'æ•°å­¦æ¥¼C102',
    start_time: '2025-01-15 14:00:00',
    end_time: '2025-01-15 15:40:00',
    status: 'NOT_STARTED',
  },
]);

// å¾…åŠäº‹é¡¹
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šsys_todo
const todoItems = ref([
  {
    todo_id: 4001, // sys_todo.todo_id
    user_id: 1001, // sys_todo.user_id
    title: 'å®Œæˆé«˜ç­‰æ•°å­¦ä½œä¸š', // sys_todo.title
    content: 'ç¬¬ä¸‰ç« ä¹ é¢˜ 1-20é¢˜', // sys_todo.content
    todo_type: 'TEACHING', // sys_todo.todo_typeï¼ˆENUMï¼‰
    priority: 'HIGH', // sys_todo.priorityï¼ˆENUM: 'LOW','MEDIUM','HIGH'ï¼‰
    deadline: '2025-10-16 23:59:00', // sys_todo.deadlineï¼ˆDATETIMEï¼‰
    is_completed: 0, // sys_todo.is_completedï¼ˆ0-æœªå®Œæˆï¼Œ1-å·²å®Œæˆï¼‰
  },
  {
    todo_id: 4002,
    user_id: 1001,
    title: 'é¢„ä¹ çº¿æ€§ä»£æ•°ç¬¬ä¸‰ç« ',
    content: 'çŸ©é˜µè¿ç®—å’Œè¡Œåˆ—å¼',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-12 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4003,
    user_id: 1001,
    title: 'æäº¤å®éªŒæŠ¥å‘Š',
    content: 'Java Webå®éªŒä¸‰',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-15 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4004,
    user_id: 1001,
    title: 'å¤ä¹ æ¦‚ç‡è®ºé‡ç‚¹',
    content: 'å¤§æ•°å®šå¾‹å’Œä¸­å¿ƒæé™å®šç†',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-14 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4005,
    user_id: 1001,
    title: 'è§‚çœ‹æ•°æ®ç»“æ„è¯¾ç¨‹å›æ”¾',
    content: 'ç¬¬äº”ç«  æ ‘å’ŒäºŒå‰æ ‘',
    todo_type: 'TEACHING',
    priority: 'LOW',
    deadline: '2025-01-14 23:59:00',
    is_completed: 1,
    complete_time: '2025-01-14 20:30:00', // sys_todo.complete_time
  },
]);
// ==================== ğŸ”´ æ¨¡æ‹Ÿæ•°æ® END ====================

// å¿«é€Ÿæ“ä½œ
const handleStartLearning = () => {
  ElMessage.info('è¿›å…¥åœ¨çº¿å­¦ä¹ åŠŸèƒ½å¼€å‘ä¸­');
};

const handleViewSchedule = () => {
  switchView('schedule');
};

const handleViewTasks = () => {
  switchView('tasks');
};

// æ·»åŠ å¾…åŠäº‹é¡¹
const handleAddTodo = () => {
  ElMessage.info('æ·»åŠ å¾…åŠäº‹é¡¹åŠŸèƒ½å¼€å‘ä¸­');
};

// åˆ¤æ–­æ˜¯å¦å·²æˆªæ­¢
const isOverdue = deadline => {
  const date = new Date(deadline);
  const now = new Date();
  return date < now;
};

// åˆ‡æ¢å¾…åŠçŠ¶æ€
const toggleTodo = todo => {
  // å·²æˆªæ­¢çš„äº‹é¡¹ä¸èƒ½æ›´æ”¹çŠ¶æ€
  if (isOverdue(todo.deadline) && todo.is_completed === 0) {
    ElMessage.warning('å·²æˆªæ­¢çš„å¾…åŠäº‹é¡¹æ— æ³•æ›´æ”¹çŠ¶æ€');
    return;
  }

  todo.is_completed = todo.is_completed === 1 ? 0 : 1;
  if (todo.is_completed === 1) {
    todo.complete_time = new Date().toISOString();
  } else {
    todo.complete_time = null;
  }
};

// æ’åºåçš„å¾…åŠäº‹é¡¹ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
// æ’åºè§„åˆ™ï¼šæœªå®Œæˆï¼ˆæœªæˆªæ­¢ï¼‰ -> æœªå®Œæˆï¼ˆå·²æˆªæ­¢ï¼‰ -> å·²å®Œæˆ
const sortedTodoItems = computed(() => {
  return [...todoItems.value].sort((a, b) => {
    // å·²å®Œæˆçš„æ’åœ¨æœ€å
    if (a.is_completed !== b.is_completed) {
      return a.is_completed - b.is_completed;
    }

    // éƒ½æ˜¯æœªå®Œæˆçš„ï¼Œå·²æˆªæ­¢çš„æ’åœ¨æœªæˆªæ­¢çš„åé¢
    if (a.is_completed === 0) {
      const aOverdue = isOverdue(a.deadline);
      const bOverdue = isOverdue(b.deadline);
      if (aOverdue !== bOverdue) {
        return aOverdue ? 1 : -1;
      }
    }

    // ç›¸åŒçŠ¶æ€æŒ‰æˆªæ­¢æ—¶é—´æ’åº
    return new Date(a.deadline) - new Date(b.deadline);
  });
});

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const formatDeadline = deadline => {
  const date = new Date(deadline);
  const now = new Date();
  const diff = date - now;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days < 0) return 'å·²æˆªæ­¢';
  if (days === 0) return 'ä»Šå¤©æˆªæ­¢';
  if (days === 1) return 'æ˜å¤©æˆªæ­¢';
  if (days <= 7) return `${days}å¤©å`;
  return date.toLocaleDateString();
};

// è·å–è¯¾ç¨‹çŠ¶æ€æ–‡æœ¬ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const getStatusText = status => {
  const statusMap = {
    ENDED: 'å·²å®Œæˆ',
    ONGOING: 'è¿›è¡Œä¸­',
    NOT_STARTED: 'æœªå¼€å§‹',
  };
  return statusMap[status] || status;
};

// æ ¼å¼åŒ–æ—¶é—´èŒƒå›´ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const formatTimeRange = (start, end) => {
  const startTime = new Date(start);
  const endTime = new Date(end);
  return `${startTime.getHours().toString().padStart(2, '0')}:${startTime
    .getMinutes()
    .toString()
    .padStart(2, '0')} - ${endTime
    .getHours()
    .toString()
    .padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
};
</script>

<template>
  <div class="today-view">
    <!-- å¿«é€Ÿå­¦ä¹ å…¥å£ -->
    <div class="quick-learning-card">
      <div class="quick-learning-header">
        <span style="font-size: 18px">âš¡</span>
        <span class="quick-learning-title">å¿«é€Ÿå­¦ä¹ </span>
      </div>
      <div class="quick-learning-buttons">
        <button
          class="quick-btn quick-btn-primary"
          @click="handleStartLearning"
        >
          <span>æŸ¥çœ‹é”™é¢˜</span>
        </button>
        <button class="quick-btn quick-btn-success" @click="handleViewSchedule">
          <span>æŸ¥çœ‹è¯¾è¡¨</span>
        </button>
        <button class="quick-btn quick-btn-warning" @click="handleViewTasks">
          <span>æˆ‘çš„ä½œä¸š</span>
        </button>
      </div>
    </div>

    <!-- ä»Šæ—¥äº‹é¡¹ä¸»å¡ç‰‡ -->
    <div class="today-card">
      <div class="today-header">
        <div class="today-header-left">
          <span style="font-size: 18px">ğŸ“…</span>
          <h2>ä»Šæ—¥äº‹é¡¹</h2>
        </div>
        <div class="today-datetime">{{ currentDateTime }}</div>
      </div>

      <div class="today-content">
        <!-- å·¦ä¾§ï¼šä»Šæ—¥è¯¾ç¨‹ -->
        <div class="today-courses">
          <div class="section-header">
            <div class="section-title">
              <span>ğŸ“š</span>
              <span>ä»Šæ—¥è¯¾ç¨‹</span>
            </div>
            <a class="section-link" @click="handleViewSchedule">æŸ¥çœ‹è¯¾è¡¨</a>
          </div>

          <div class="course-timeline">
            <div
              v-for="course in todayCourses"
              :key="course.session_id"
              :class="[
                'course-item',
                course.status === 'ENDED'
                  ? 'completed'
                  : course.status === 'ONGOING'
                    ? 'current'
                    : 'upcoming',
              ]"
            >
              <div class="course-time">
                {{ formatTimeRange(course.start_time, course.end_time) }}
              </div>
              <div class="course-info">
                <div class="course-title">
                  <span class="course-name">{{ course.course_name }}</span>
                  <span
                    :class="[
                      'course-status',
                      course.status === 'ENDED'
                        ? 'done'
                        : course.status === 'ONGOING'
                          ? 'ongoing'
                          : 'coming',
                    ]"
                  >
                    {{ getStatusText(course.status) }}
                  </span>
                </div>
                <div class="course-details">
                  <span>ğŸ¢ {{ course.classroom_name }}</span>
                  <span>ğŸ§‘â€ğŸ« {{ course.teacher_name }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šå¾…åŠäº‹é¡¹ -->
        <div class="today-todos">
          <div class="section-header">
            <div class="section-title">
              <span>ğŸ“‹</span>
              <span>å¾…åŠäº‹é¡¹</span>
            </div>
            <a class="section-link" @click="handleAddTodo">æ·»åŠ </a>
          </div>

          <div class="todo-list">
            <div
              v-for="todo in sortedTodoItems"
              :key="todo.todo_id"
              :class="[
                'todo-item',
                {
                  urgent:
                    todo.priority === 'HIGH' &&
                    todo.is_completed === 0 &&
                    !isOverdue(todo.deadline),
                  normal:
                    todo.priority !== 'HIGH' &&
                    todo.is_completed === 0 &&
                    !isOverdue(todo.deadline),
                  overdue: isOverdue(todo.deadline) && todo.is_completed === 0,
                  completed: todo.is_completed === 1,
                },
              ]"
            >
              <input
                type="checkbox"
                :checked="todo.is_completed === 1"
                :disabled="isOverdue(todo.deadline) && todo.is_completed === 0"
                class="todo-checkbox"
                @change="toggleTodo(todo)"
              />
              <div class="todo-label">
                {{ todo.title }}
              </div>
              <span class="todo-deadline">
                {{
                  todo.is_completed === 1
                    ? 'å·²å®Œæˆ'
                    : formatDeadline(todo.deadline)
                }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
