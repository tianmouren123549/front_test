<style scoped>
/* ‰ªäÊó•‰∫ãÈ°πËßÜÂõæ */
.today-view {
  padding: 0;
  height: 100%;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  overflow: hidden;
}

/* ‰ªäÊó•‰∫ãÈ°π‰∏ªÂç°Áâá */
.today-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
  flex: 6;
  display: flex;
  flex-direction: column;
  min-height: 0;
  margin: 16px 20px 0 20px;
}

.today-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
}

.today-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.today-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.today-datetime {
  color: #6b7280;
  font-size: 14px;
}

.today-content {
  display: grid;
  grid-template-columns: 3fr 2fr;
  gap: 24px;
  padding: 24px;
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

/* ‰ªäÊó•ËØæÁ®ã */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
}

.section-link {
  color: var(--primary-color);
  text-decoration: none;
  font-size: 12px;
  cursor: pointer;
}

.section-link:hover {
  text-decoration: underline;
}

.course-timeline {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.course-item {
  display: flex;
  gap: 16px;
  padding: 16px;
  border-radius: 6px;
  border-left: 3px solid #e5e7eb;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-left-width: 3px;
  transition: all 0.2s ease;
}

.course-item:hover {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.course-item.completed {
  border-left-color: #22c55e;
  background: #ffffff;
}

.course-item.current {
  border-left-color: #f59e0b;
  background: #ffffff;
  box-shadow: 0 2px 6px rgba(245, 158, 11, 0.1);
}

.course-item.upcoming {
  border-left-color: #3b82f6;
  background: #ffffff;
}

.course-time {
  min-width: 100px;
  font-weight: 600;
  color: #1f2937;
  font-size: 14px;
}

.course-info {
  flex: 1;
}

.course-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.course-name {
  font-weight: 600;
  color: #1f2937;
  font-size: 15px;
}

.course-status {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
  border: 1px solid;
}

.course-status.done {
  background: #f0fdf4;
  color: #16a34a;
  border-color: #bbf7d0;
}

.course-status.ongoing {
  background: #fffbeb;
  color: #d97706;
  border-color: #fde68a;
}

.course-status.coming {
  background: #eff6ff;
  color: #2563eb;
  border-color: #bfdbfe;
}

.course-details {
  display: flex;
  gap: 12px;
  color: #6b7280;
  font-size: 12px;
}

/* ÂæÖÂäû‰∫ãÈ°π */
.todo-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.todo-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border-radius: 8px;
  background: #fff;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
}

.todo-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.todo-item.urgent {
  border-left: 3px solid #3b82f6;
  background: #ffffff;
}

.todo-item.normal {
  border-left: 3px solid #d1d5db;
  background: #ffffff;
}

.todo-item.overdue {
  border-left: 3px solid #dc2626;
  background: #ffffff;
}

.todo-item.completed {
  background: #f9fafb;
  opacity: 0.7;
}

.todo-item.completed .todo-label {
  text-decoration: line-through;
  color: #6b7280;
}

.todo-item.overdue .todo-label {
  color: #991b1b;
}

.todo-checkbox {
  cursor: pointer;
}

.todo-checkbox:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.todo-label {
  flex: 1;
  font-size: 14px;
  color: #1f2937;
}

.todo-deadline {
  font-size: 11px;
  color: #6b7280;
  white-space: nowrap;
}

.todo-item.urgent .todo-deadline {
  color: #2563eb;
  font-weight: 600;
}

.todo-item.overdue .todo-deadline {
  color: #dc2626;
  font-weight: 600;
}

/* Êô∫ËÉΩÊé®ËçêÂå∫Âüü */
.smart-recommendation {
  margin: 12px 20px 20px 20px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px 20px;
  flex: 4;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.recommendation-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
}

.recommendation-icon {
  font-size: 18px;
}

.recommendation-title {
  font-size: 15px;
  font-weight: 600;
  color: #1f2937;
}

.recommendation-badge {
  padding: 2px 6px;
  background: #fef2f2;
  color: #dc2626;
  font-size: 10px;
  font-weight: 500;
  border-radius: 3px;
  border: 1px solid #fecaca;
}

.recommendation-content {
  color: #6b7280;
  font-size: 13px;
  line-height: 1.5;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow-y: auto;
  min-height: 0;
}

.recommendation-placeholder {
  text-align: center;
  padding: 20px;
  color: #9ca3af;
  font-size: 13px;
}

/* ÂìçÂ∫îÂºè */
@media (max-width: 1200px) {
  .today-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
}

@media (max-width: 860px) {
  .today-view {
    padding: 12px;
  }

  .today-content {
    padding: 16px;
    gap: 16px;
  }

  .course-item {
    padding: 12px;
  }

  .todo-item {
    padding: 10px;
  }

  .smart-recommendation {
    margin-top: 12px;
    padding: 14px 16px;
  }

  .recommendation-placeholder {
    padding: 20px 16px;
  }
}
</style>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { ElMessage } from 'element-plus';

// ÂΩìÂâçÊó•ÊúüÊó∂Èó¥
const currentDateTime = ref('');

const updateDateTime = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const date = now.getDate();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const weekdays = [
    'ÊòüÊúüÊó•',
    'ÊòüÊúü‰∏Ä',
    'ÊòüÊúü‰∫å',
    'ÊòüÊúü‰∏â',
    'ÊòüÊúüÂõõ',
    'ÊòüÊúü‰∫î',
    'ÊòüÊúüÂÖ≠',
  ];
  const weekday = weekdays[now.getDay()];
  currentDateTime.value = `${year}Âπ¥${month}Êúà${date}Êó•${weekday} ${hours}:${minutes}`;
};

onMounted(() => {
  updateDateTime();
  setInterval(updateDateTime, 60000); // ÊØèÂàÜÈíüÊõ¥Êñ∞
});

// ==================== üî¥ Ê®°ÊãüÊï∞ÊçÆ START ====================
// TODO: ÂêéÁª≠ÈúÄË¶Å‰ªéÂêéÁ´ØAPIËé∑ÂèñÁúüÂÆûÊï∞ÊçÆ
// APIÊé•Âè£: GET /api/student/today-schedule
// ÂØπÂ∫îÊï∞ÊçÆÂ∫ìË°®Ôºöclass_session, edu_course, sys_user, edu_classroom

// ‰ªäÊó•ËØæÁ®ã
const todayCourses = ref([
  {
    session_id: 3001, // class_session.session_id
    course_id: 601, // edu_course.course_id
    course_name: 'È´òÁ≠âÊï∞Â≠¶', // edu_course.course_name
    teacher_id: 211, // edu_teacher.teacher_id
    teacher_name: 'ÁéãËÄÅÂ∏à', // sys_user.real_name
    classroom_id: 301, // edu_classroom.classroom_id
    classroom_name: 'Êï∞Â≠¶Ê•ºA301', // edu_classroom.building + classroom_name
    start_time: '2025-01-15 08:00:00', // class_session.start_timeÔºàDATETIMEÔºâ
    end_time: '2025-01-15 09:40:00', // class_session.end_timeÔºàDATETIMEÔºâ
    status: 'ENDED', // class_session.statusÔºàENUM: 'NOT_STARTED','ONGOING','ENDED'Ôºâ
  },
  {
    session_id: 3002,
    course_id: 604,
    course_name: 'Á∫øÊÄß‰ª£Êï∞',
    teacher_id: 214,
    teacher_name: 'ÊùéËÄÅÂ∏à',
    classroom_id: 302,
    classroom_name: 'Êï∞Â≠¶Ê•ºB205',
    start_time: '2025-01-15 10:00:00',
    end_time: '2025-01-15 11:40:00',
    status: 'ONGOING',
  },
  {
    session_id: 3003,
    course_id: 611,
    course_name: 'Ê¶ÇÁéáËÆ∫‰∏éÊï∞ÁêÜÁªüËÆ°',
    teacher_id: 221,
    teacher_name: 'Âº†ËÄÅÂ∏à',
    classroom_id: 303,
    classroom_name: 'Êï∞Â≠¶Ê•ºC102',
    start_time: '2025-01-15 14:00:00',
    end_time: '2025-01-15 15:40:00',
    status: 'NOT_STARTED',
  },
]);

// ÂæÖÂäû‰∫ãÈ°π
// ÂØπÂ∫îÊï∞ÊçÆÂ∫ìË°®Ôºösys_todo
const todoItems = ref([
  {
    todo_id: 4001, // sys_todo.todo_id
    user_id: 1001, // sys_todo.user_id
    title: 'ÂÆåÊàêÈ´òÁ≠âÊï∞Â≠¶‰Ωú‰∏ö', // sys_todo.title
    content: 'Á¨¨‰∏âÁ´†‰π†È¢ò 1-20È¢ò', // sys_todo.content
    todo_type: 'TEACHING', // sys_todo.todo_typeÔºàENUMÔºâ
    priority: 'HIGH', // sys_todo.priorityÔºàENUM: 'LOW','MEDIUM','HIGH'Ôºâ
    deadline: '2025-10-16 23:59:00', // sys_todo.deadlineÔºàDATETIMEÔºâ
    is_completed: 0, // sys_todo.is_completedÔºà0-Êú™ÂÆåÊàêÔºå1-Â∑≤ÂÆåÊàêÔºâ
  },
  {
    todo_id: 4002,
    user_id: 1001,
    title: 'È¢Ñ‰π†Á∫øÊÄß‰ª£Êï∞Á¨¨‰∏âÁ´†',
    content: 'Áü©ÈòµËøêÁÆóÂíåË°åÂàóÂºè',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-12 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4003,
    user_id: 1001,
    title: 'Êèê‰∫§ÂÆûÈ™åÊä•Âëä',
    content: 'Java WebÂÆûÈ™å‰∏â',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-15 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4004,
    user_id: 1001,
    title: 'Â§ç‰π†Ê¶ÇÁéáËÆ∫ÈáçÁÇπ',
    content: 'Â§ßÊï∞ÂÆöÂæãÂíå‰∏≠ÂøÉÊûÅÈôêÂÆöÁêÜ',
    todo_type: 'TEACHING',
    priority: 'MEDIUM',
    deadline: '2025-10-14 23:59:00',
    is_completed: 0,
  },
  {
    todo_id: 4005,
    user_id: 1001,
    title: 'ËßÇÁúãÊï∞ÊçÆÁªìÊûÑËØæÁ®ãÂõûÊîæ',
    content: 'Á¨¨‰∫îÁ´† Ê†ëÂíå‰∫åÂèâÊ†ë',
    todo_type: 'TEACHING',
    priority: 'LOW',
    deadline: '2025-01-14 23:59:00',
    is_completed: 1,
    complete_time: '2025-01-14 20:30:00', // sys_todo.complete_time
  },
]);
// ==================== üî¥ Ê®°ÊãüÊï∞ÊçÆ END ====================

// Ê∑ªÂä†ÂæÖÂäû‰∫ãÈ°π
const handleAddTodo = () => {
  ElMessage.info('Ê∑ªÂä†ÂæÖÂäû‰∫ãÈ°πÂäüËÉΩÂºÄÂèë‰∏≠');
};

// Âà§Êñ≠ÊòØÂê¶Â∑≤Êà™Ê≠¢
const isOverdue = deadline => {
  const date = new Date(deadline);
  const now = new Date();
  return date < now;
};

// ÂàáÊç¢ÂæÖÂäûÁä∂ÊÄÅ
const toggleTodo = todo => {
  // Â∑≤Êà™Ê≠¢ÁöÑ‰∫ãÈ°π‰∏çËÉΩÊõ¥ÊîπÁä∂ÊÄÅ
  if (isOverdue(todo.deadline) && todo.is_completed === 0) {
    ElMessage.warning('Â∑≤Êà™Ê≠¢ÁöÑÂæÖÂäû‰∫ãÈ°πÊó†Ê≥ïÊõ¥ÊîπÁä∂ÊÄÅ');
    return;
  }

  todo.is_completed = todo.is_completed === 1 ? 0 : 1;
  if (todo.is_completed === 1) {
    todo.complete_time = new Date().toISOString();
  } else {
    todo.complete_time = null;
  }
};

// ÊéíÂ∫èÂêéÁöÑÂæÖÂäû‰∫ãÈ°πÔºàÁî®‰∫éÂâçÁ´ØÊòæÁ§∫Ôºâ
// ÊéíÂ∫èËßÑÂàôÔºöÊú™ÂÆåÊàêÔºàÊú™Êà™Ê≠¢Ôºâ -> Êú™ÂÆåÊàêÔºàÂ∑≤Êà™Ê≠¢Ôºâ -> Â∑≤ÂÆåÊàê
const sortedTodoItems = computed(() => {
  return [...todoItems.value].sort((a, b) => {
    // Â∑≤ÂÆåÊàêÁöÑÊéíÂú®ÊúÄÂêé
    if (a.is_completed !== b.is_completed) {
      return a.is_completed - b.is_completed;
    }

    // ÈÉΩÊòØÊú™ÂÆåÊàêÁöÑÔºåÂ∑≤Êà™Ê≠¢ÁöÑÊéíÂú®Êú™Êà™Ê≠¢ÁöÑÂêéÈù¢
    if (a.is_completed === 0) {
      const aOverdue = isOverdue(a.deadline);
      const bOverdue = isOverdue(b.deadline);
      if (aOverdue !== bOverdue) {
        return aOverdue ? 1 : -1;
      }
    }

    // Áõ∏ÂêåÁä∂ÊÄÅÊåâÊà™Ê≠¢Êó∂Èó¥ÊéíÂ∫è
    return new Date(a.deadline) - new Date(b.deadline);
  });
});

// Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÔºàÁî®‰∫éÂâçÁ´ØÊòæÁ§∫Ôºâ
const formatDeadline = deadline => {
  const date = new Date(deadline);
  const now = new Date();
  const diff = date - now;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days < 0) return 'Â∑≤Êà™Ê≠¢';
  if (days === 0) return '‰ªäÂ§©Êà™Ê≠¢';
  if (days === 1) return 'ÊòéÂ§©Êà™Ê≠¢';
  if (days <= 7) return `${days}Â§©Âêé`;
  return date.toLocaleDateString();
};

// Ëé∑ÂèñËØæÁ®ãÁä∂ÊÄÅÊñáÊú¨ÔºàÁî®‰∫éÂâçÁ´ØÊòæÁ§∫Ôºâ
const getStatusText = status => {
  const statusMap = {
    ENDED: 'Â∑≤ÂÆåÊàê',
    ONGOING: 'ËøõË°å‰∏≠',
    NOT_STARTED: 'Êú™ÂºÄÂßã',
  };
  return statusMap[status] || status;
};

// Ê†ºÂºèÂåñÊó∂Èó¥ËåÉÂõ¥ÔºàÁî®‰∫éÂâçÁ´ØÊòæÁ§∫Ôºâ
const formatTimeRange = (start, end) => {
  const startTime = new Date(start);
  const endTime = new Date(end);
  return `${startTime.getHours().toString().padStart(2, '0')}:${startTime
    .getMinutes()
    .toString()
    .padStart(2, '0')} - ${endTime
    .getHours()
    .toString()
    .padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
};
</script>

<template>
  <div class="today-view">
    <!-- ‰ªäÊó•‰∫ãÈ°π‰∏ªÂç°Áâá -->
    <div class="today-card">
      <div class="today-header">
        <div class="today-header-left">
          <h2>‰ªäÊó•‰∫ãÈ°π</h2>
        </div>
        <div class="today-datetime">{{ currentDateTime }}</div>
      </div>

      <div class="today-content">
        <!-- Â∑¶‰æßÔºö‰ªäÊó•ËØæÁ®ã -->
        <div class="today-courses">
          <div class="section-header">
            <div class="section-title">
              <span>‰ªäÊó•ËØæÁ®ã</span>
            </div>
            <a class="section-link" @click="handleViewSchedule">Êü•ÁúãËØæË°®</a>
          </div>

          <div class="course-timeline">
            <div
              v-for="course in todayCourses"
              :key="course.session_id"
              :class="[
                'course-item',
                course.status === 'ENDED'
                  ? 'completed'
                  : course.status === 'ONGOING'
                    ? 'current'
                    : 'upcoming',
              ]"
            >
              <div class="course-time">
                {{ formatTimeRange(course.start_time, course.end_time) }}
              </div>
              <div class="course-info">
                <div class="course-title">
                  <span class="course-name">{{ course.course_name }}</span>
                  <span
                    :class="[
                      'course-status',
                      course.status === 'ENDED'
                        ? 'done'
                        : course.status === 'ONGOING'
                          ? 'ongoing'
                          : 'coming',
                    ]"
                  >
                    {{ getStatusText(course.status) }}
                  </span>
                </div>
                <div class="course-details">
                  <span>ÊïôÂÆ§Ôºö{{ course.classroom_name }}</span>
                  <span>ÊïôÂ∏àÔºö{{ course.teacher_name }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Âè≥‰æßÔºöÂæÖÂäû‰∫ãÈ°π -->
        <div class="today-todos">
          <div class="section-header">
            <div class="section-title">
              <span>ÂæÖÂäû‰∫ãÈ°π</span>
            </div>
            <a class="section-link" @click="handleAddTodo">Ê∑ªÂä†</a>
          </div>

          <div class="todo-list">
            <div
              v-for="todo in sortedTodoItems"
              :key="todo.todo_id"
              :class="[
                'todo-item',
                {
                  urgent:
                    todo.priority === 'HIGH' &&
                    todo.is_completed === 0 &&
                    !isOverdue(todo.deadline),
                  normal:
                    todo.priority !== 'HIGH' &&
                    todo.is_completed === 0 &&
                    !isOverdue(todo.deadline),
                  overdue: isOverdue(todo.deadline) && todo.is_completed === 0,
                  completed: todo.is_completed === 1,
                },
              ]"
            >
              <input
                type="checkbox"
                :checked="todo.is_completed === 1"
                :disabled="isOverdue(todo.deadline) && todo.is_completed === 0"
                class="todo-checkbox"
                @change="toggleTodo(todo)"
              />
              <div class="todo-label">
                {{ todo.title }}
              </div>
              <span class="todo-deadline">
                {{
                  todo.is_completed === 1
                    ? 'Â∑≤ÂÆåÊàê'
                    : formatDeadline(todo.deadline)
                }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Êô∫ËÉΩÊé®ËçêÂå∫ÂüüÔºàÈ¢ÑÁïôÔºâ -->
    <div class="smart-recommendation">
      <div class="recommendation-header">
        <span class="recommendation-title">‰ªäÊó•Êô∫ËÉΩÊé®Ëçê</span>
        <span class="recommendation-badge">ÊöÇÂÆö</span>
      </div>
      <div class="recommendation-content">
        <div class="recommendation-placeholder">
          ËØ•ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖ...
        </div>
      </div>
    </div>
  </div>
</template>
