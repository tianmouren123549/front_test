<style scoped>
.course-detail {
  display: flex;
  min-height: 100vh;
  background: #f7f8fb;
}

.sidebar {
  width: 257px; /* ç»Ÿä¸€å®½åº¦ */
  background: #fff;
  border-right: 1px solid #e5e7eb;
  padding: 20px 16px; /* ç»Ÿä¸€å†…è¾¹è· */
  flex-shrink: 0;
  transition: transform 0.3s ease;
}

.brand {
  font-weight: 700;
  color: #64748b;
  font-size: 16px; /* ç»Ÿä¸€å­—ä½“å¤§å° */
  margin-bottom: 16px;
}

.sidebar-menu {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.menu-item {
  padding: 12px 14px; /* ç»Ÿä¸€å†…è¾¹è· */
  border-radius: 8px;
  color: #334155;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 15px; /* ç»Ÿä¸€å­—ä½“å¤§å° */
  font-weight: 500; /* ç»Ÿä¸€å­—ä½“ç²—ç»† */
}

.menu-item:hover {
  background: #f1f5f9;
}

.menu-item.active {
  background: #f1f5f9;
  color: var(--primary-color);
  font-weight: 600; /* ç»Ÿä¸€æ¿€æ´»æ—¶ç²—ç»† */
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.topbar {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 14px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #6b7280;
  font-size: 13px;
}

.breadcrumb a {
  color: #6b7280;
  text-decoration: none;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.3s;
}

.breadcrumb a:hover {
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.08);
}

.breadcrumb .current {
  color: #10b981;
  font-weight: 500;
}

.topbar-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.content-area {
  padding: 20px 24px;
  overflow-y: auto;
}

.panel {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
}

.panel-title {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sub-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.sub-tab {
  padding: 8px 16px;
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.sub-tab.active {
  background: var(--primary-color);
  color: #fff;
  border-color: var(--primary-color);
}

/* å­¦ä¹ æ—¥å¿— */
.log-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  margin-bottom: 12px;
}

.log-date {
  width: 80px;
  color: #6b7280;
  font-size: 12px;
}

.log-card {
  flex: 1;
  background: #fafafa;
  padding: 10px;
  border-radius: 8px;
}

.log-time {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

.log-tag {
  display: inline-block;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 999px;
  background: #eef2ff;
  color: #3730a3;
  margin-bottom: 4px;
}

/* å­¦ä¹ ç”»åƒ */
.knowledge-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.knowledge-card {
  border-radius: 10px;
  padding: 14px;
  position: relative;
}

.knowledge-card.weak {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border: 1px solid #fecaca;
}

.knowledge-card.good {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 1px solid #bbf7d0;
}

.knowledge-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.knowledge-name {
  font-weight: 600;
  font-size: 14px;
}

.knowledge-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  color: #fff;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #f1f5f9;
  border-radius: 3px;
  overflow: hidden;
  margin: 8px 0;
}

.progress-fill {
  height: 100%;
  transition: width 0.3s;
}

/* é”™é¢˜è®°å½• */
.wrong-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.filter-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.filter-btn {
  padding: 6px 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.filter-btn.active {
  background: var(--primary-color);
  color: #fff;
  border-color: var(--primary-color);
}

.wrong-card {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
}

.wrong-question {
  font-weight: 600;
  margin-bottom: 6px;
}

.wrong-answer {
  color: #6b7280;
  font-size: 13px;
  margin: 4px 0;
}

.wrong-tip {
  color: #ef4444;
  font-size: 12px;
  margin-top: 6px;
}

/* ç« èŠ‚åˆ—è¡¨ */
.chapter-card {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
}

.chapter-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.chapter-number {
  width: 40px;
  height: 40px;
  background: var(--primary-color);
  color: #fff;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
}

.chapter-info {
  flex: 1;
}

.chapter-title {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 4px;
}

.chapter-meta {
  color: #6b7280;
  font-size: 13px;
}

.chapter-content {
  color: #4b5563;
  font-size: 14px;
  margin-bottom: 12px;
}

/* ä½œä¸š/è€ƒè¯• */
.task-card {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.task-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.task-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.task-icon {
  font-size: 20px;
}

.task-info {
  flex: 1;
}

.task-title {
  font-weight: 600;
  margin-bottom: 2px;
}

.task-time {
  color: #6b7280;
  font-size: 13px;
}

.task-status {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.status-pending {
  background: #fff7e6;
  color: #f59e0b;
}

.status-completed {
  background: #f0f9ff;
  color: #22c55e;
}

/* æ±‰å ¡èœå•æŒ‰é’®å’Œé®ç½©å±‚æ ·å¼ç»§æ‰¿è‡ª components.css */

/* é®ç½©å±‚åœ¨è¯¾ç¨‹è¯¦ç»†é¡µçš„ç‰¹æ®Šå®šä½ï¼ˆPCç«¯ä»ä¾§è¾¹æ å³è¾¹å¼€å§‹ï¼‰ */
.sidebar-overlay {
  left: var(--sidebar-width);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 860px) {
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 1000; /* æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨é®ç½©ä¸Šæ–¹ */
    transform: translateX(-100%);
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    overflow-y: auto; /* æ·»åŠ æ»šåŠ¨ */
  }

  .sidebar.mobile-open {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
    width: 100%;
  }

  .sidebar-overlay {
    left: 0; /* ç§»åŠ¨ç«¯ä»å·¦è¾¹å¼€å§‹ï¼Œè¦†ç›–PCç«¯çš„ä¾§è¾¹æ å³è¾¹å®šä½ */
  }

  .topbar {
    padding-left: 70px;
  }
}

@media (max-width: 480px) {
  .topbar {
    padding: 12px 16px 12px 70px;
  }

  .content-area {
    padding: 16px;
  }

  .panel {
    padding: 16px;
  }
}
</style>

<script setup>
import { ref, computed } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { ElMessage } from 'element-plus';
import MobileMenuToggle from '@/components/common/MobileMenuToggle.vue';
import SidebarOverlay from '@/components/common/SidebarOverlay.vue';

const router = useRouter();
const route = useRoute();

// è·å–è¯¾ç¨‹åç§°ï¼ˆä»è·¯ç”±å‚æ•°ï¼‰
const courseName = computed(() => route.query.course || 'è¯¾ç¨‹åç§°');

// å½“å‰æ¿€æ´»çš„è§†å›¾
const activeView = ref('learning');
const activeLearningTab = ref('log');
const activeTaskTab = ref('homework');

// ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶
const sidebarOpen = ref(false);

const toggleSidebar = () => {
  sidebarOpen.value = !sidebarOpen.value;
};

const closeSidebar = () => {
  sidebarOpen.value = false;
};

// ==================== ğŸ”´ æ¨¡æ‹Ÿæ•°æ® START ====================
// TODO: åç»­éœ€è¦ä»åç«¯APIè·å–è¯¾ç¨‹è¯¦æƒ…æ•°æ®
// APIæ¥å£: GET /api/course/detail?courseId=xxx
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šstu_learning_record, edu_knowledge_point, stu_wrong_question, edu_course_chapter, eval_assignment, edu_exam_arrangement, analysis_score

// å­¦ä¹ æ—¥å¿—æ•°æ®
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šstu_learning_record
const learningLogs = ref([
  {
    record_id: 8001, // stu_learning_record.record_id
    student_id: 1001, // stu_learning_record.student_id
    course_id: 601, // stu_learning_record.course_id
    chapter_id: 901, // stu_learning_record.chapter_id
    learning_type: 'MATERIAL', // stu_learning_record.learning_type (ENUM: 'VIDEO','MATERIAL','EXERCISE','REVIEW')
    content_title: 'ç¬¬6ç«  å®šç§¯åˆ†çš„åº”ç”¨', // stu_learning_record.content_title
    start_time: '2025-12-15 08:30:00', // stu_learning_record.start_time (DATETIME)
    end_time: '2025-12-15 09:30:00', // stu_learning_record.end_time (DATETIME)
    duration: 3600, // stu_learning_record.duration (ç§’)
    progress: 100, // stu_learning_record.progress (0-100)
    status: 'COMPLETED', // stu_learning_record.status (ENUM: 'IN_PROGRESS','COMPLETED','PAUSED')
  },
  {
    record_id: 8002,
    student_id: 1001,
    course_id: 601,
    chapter_id: 902,
    learning_type: 'EXERCISE',
    content_title: 'å¯¼æ•°è¿ç®—ç»ƒä¹ ',
    start_time: '2025-12-10 10:00:00',
    end_time: '2025-12-10 10:45:00',
    duration: 2700,
    progress: 100,
    status: 'COMPLETED',
  },
  {
    record_id: 8003,
    student_id: 1001,
    course_id: 601,
    chapter_id: 901,
    learning_type: 'VIDEO',
    content_title: 'ç¬¬5ç«  å¾®åˆ†ä¸­å€¼å®šç†',
    start_time: '2025-12-08 08:30:00',
    end_time: '2025-12-08 09:15:00',
    duration: 2700,
    progress: 100,
    status: 'COMPLETED',
  },
]);

// çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šedu_knowledge_point, analysis_student_profile
const knowledgePoints = ref([
  {
    point_id: 1001, // edu_knowledge_point.point_id
    course_id: 601, // edu_knowledge_point.course_id
    point_name: 'æé™', // edu_knowledge_point.point_name
    difficulty_level: 3, // edu_knowledge_point.difficulty_level (1-5)
    importance_level: 5, // edu_knowledge_point.importance_level (1-5)
    mastery_rate: 37, // analysis_student_profile.mastery_rate (æ¥è‡ªå­¦ç”Ÿç”»åƒåˆ†æè¡¨)
  },
  {
    point_id: 1002,
    course_id: 601,
    point_name: 'å¯¼æ•°',
    difficulty_level: 4,
    importance_level: 4,
    mastery_rate: 49,
  },
  {
    point_id: 1003,
    course_id: 601,
    point_name: 'å¾®åˆ†åº”ç”¨',
    difficulty_level: 3,
    importance_level: 4,
    mastery_rate: 78,
  },
  {
    point_id: 1004,
    course_id: 601,
    point_name: 'ç§¯åˆ†',
    difficulty_level: 4,
    importance_level: 5,
    mastery_rate: 55,
  },
]);

// é”™é¢˜ç­›é€‰ç±»å‹
const wrongFilter = ref('all');
// é”™é¢˜è®°å½•
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šstu_wrong_question, prep_question_bank
const wrongQuestions = ref([
  {
    wrong_id: 1, // stu_wrong_question.wrong_id
    student_id: 1001, // stu_wrong_question.student_id
    question_id: 2001, // stu_wrong_question.question_id
    course_id: 601, // stu_wrong_question.course_id
    question_type: 'BLANK', // prep_question_bank.question_type (ENUM: 'SINGLE','MULTIPLE','JUDGE','BLANK','ESSAY')
    question_text: 'Q1. æ±‚æé™ lim(xâ†’0) (sin x)/x = ____', // prep_question_bank.question_text
    wrong_answer: '0', // stu_wrong_question.wrong_answer
    correct_answer: '1', // prep_question_bank.answer
    analysis: 'è¿™æ˜¯é‡è¦æé™å…¬å¼ï¼Œéœ€ç†Ÿè®°', // prep_question_bank.analysis
    wrong_time: '2025-12-08 10:30:00', // stu_wrong_question.wrong_time (DATETIME)
  },
  {
    wrong_id: 2,
    student_id: 1001,
    question_id: 2002,
    course_id: 601,
    question_type: 'SINGLE',
    question_text: 'Q2. å‡½æ•° f(x) = xÂ³ çš„å¯¼æ•°æ˜¯ï¼Ÿ',
    wrong_answer: 'A',
    correct_answer: 'B) 3xÂ²',
    analysis: "å¹‚å‡½æ•°æ±‚å¯¼æ³•åˆ™ (xâ¿)' = nÂ·xâ¿â»Â¹",
    wrong_time: '2025-12-07 14:20:00',
  },
  {
    wrong_id: 3,
    student_id: 1001,
    question_id: 2003,
    course_id: 601,
    question_type: 'ESSAY',
    question_text: 'Q3. æ±‚å®šç§¯åˆ† âˆ«[0,1] 2x dx = ?',
    wrong_answer: 'xÂ²',
    correct_answer: '1',
    analysis: 'è®°å¾—ä»£å…¥ä¸Šä¸‹é™è¿›è¡Œè®¡ç®—',
    wrong_time: '2025-12-06 16:45:00',
  },
]);

// è¿‡æ»¤åçš„é”™é¢˜
const filteredWrongQuestions = computed(() => {
  if (wrongFilter.value === 'all') {
    return wrongQuestions.value;
  }
  // å‰ç«¯ç­›é€‰ç±»å‹æ˜ å°„åˆ°æ•°æ®åº“ENUM
  const typeMap = {
    choice: 'SINGLE',
    fill: 'BLANK',
    calculation: 'ESSAY',
  };
  return wrongQuestions.value.filter(
    q => q.question_type === typeMap[wrongFilter.value]
  );
});

// ç« èŠ‚åˆ—è¡¨
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šedu_course_chapter
const chapters = ref([
  {
    chapter_id: 901, // edu_course_chapter.chapter_id
    course_id: 601, // edu_course_chapter.course_id
    chapter_no: '1', // edu_course_chapter.chapter_no
    chapter_name: 'ç¬¬ä¸€ç«  å‡½æ•°ä¸æé™', // edu_course_chapter.chapter_name
    learning_hours: 4, // edu_course_chapter.learning_hours
    learning_objectives: 'ä¸»è¦å†…å®¹ï¼šå‡½æ•°çš„æ¦‚å¿µã€æé™çš„å®šä¹‰ä¸æ€§è´¨ã€è¿ç»­æ€§', // edu_course_chapter.learning_objectives
    completion_status: 'COMPLETED', // å‰ç«¯è®¡ç®—å­—æ®µ (ENUM: 'NOT_STARTED','IN_PROGRESS','COMPLETED')
    knowledge_point_count: 8, // å‰ç«¯ç»Ÿè®¡å­—æ®µï¼Œç”¨äºæ˜¾ç¤º"8ä¸ªçŸ¥è¯†ç‚¹"
  },
  {
    chapter_id: 902,
    course_id: 601,
    chapter_no: '2',
    chapter_name: 'ç¬¬äºŒç«  å¯¼æ•°ä¸å¾®åˆ†',
    learning_hours: 5,
    learning_objectives: 'ä¸»è¦å†…å®¹ï¼šå¯¼æ•°çš„æ¦‚å¿µã€æ±‚å¯¼æ³•åˆ™ã€å¾®åˆ†çš„åº”ç”¨',
    completion_status: 'IN_PROGRESS',
    knowledge_point_count: 10,
  },
  {
    chapter_id: 903,
    course_id: 601,
    chapter_no: '3',
    chapter_name: 'ç¬¬ä¸‰ç«  ç§¯åˆ†å­¦',
    learning_hours: 6,
    learning_objectives: 'ä¸»è¦å†…å®¹ï¼šä¸å®šç§¯åˆ†ã€å®šç§¯åˆ†ã€ç§¯åˆ†çš„åº”ç”¨',
    completion_status: 'NOT_STARTED',
    knowledge_point_count: 12,
  },
]);

// ä½œä¸šåˆ—è¡¨
// å¯¹åº”æ•°æ®åº“è¡¨ï¼ševal_assignment, eval_submission
const homeworks = ref([
  {
    assignment_id: 5001, // eval_assignment.assignment_id
    course_id: 601, // eval_assignment.course_id
    title: 'ç¬¬6ç«  å¯¼æ•°è¿ç®—', // eval_assignment.title
    end_time: '2025-12-20 23:59:00', // eval_assignment.end_time (DATETIME)
    total_score: 10, // eval_assignment.total_score
    submission_status: 'NOT_SUBMITTED', // eval_submission.status (ENUM: 'NOT_SUBMITTED','SUBMITTED','GRADING','GRADED','RETURNED')
  },
  {
    assignment_id: 5002,
    course_id: 601,
    title: 'ç¬¬5ç«  å¾®åˆ†ä¸­å€¼å®šç†',
    end_time: '2025-12-15 23:59:00',
    total_score: 8,
    submission_status: 'GRADED',
  },
]);

// è€ƒè¯•åˆ—è¡¨
// å¯¹åº”æ•°æ®åº“è¡¨ï¼šedu_exam_arrangement, analysis_score
const exams = ref([
  {
    arrangement_id: 1, // edu_exam_arrangement.arrangement_id
    course_id: 601, // edu_exam_arrangement.course_id
    exam_name: 'æœŸä¸­è€ƒè¯•', // edu_exam_arrangement.exam_name
    exam_date: '2025-11-20', // edu_exam_arrangement.exam_date (DATE)
    start_time: '14:00:00', // edu_exam_arrangement.start_time (TIME)
    end_time: '16:00:00', // edu_exam_arrangement.end_time (TIME)
    total_score: null, // analysis_score.total_score (å¦‚æœå·²è€ƒè¯•å¹¶è¯„åˆ†)
  },
  {
    arrangement_id: 2,
    course_id: 601,
    exam_name: 'ç¬¬ä¸€æ¬¡æœˆè€ƒ',
    exam_date: '2025-10-15',
    start_time: '14:00:00',
    end_time: '16:00:00',
    total_score: 85,
  },
]);
// ==================== ğŸ”´ æ¨¡æ‹Ÿæ•°æ® END ====================

// è¿”å›ä¸Šä¸€é¡µ
const goBack = () => {
  router.push('/student');
};

// è¿›å…¥è¯¾å ‚
const enterClassroom = () => {
  ElMessage.info('è¿›å…¥è¯¾å ‚åŠŸèƒ½å¼€å‘ä¸­');
};

// åˆ‡æ¢è§†å›¾
const switchView = view => {
  activeView.value = view;
};

// æŸ¥çœ‹çŸ¥è¯†ç‚¹è¯¦æƒ…
const viewKnowledge = content => {
  ElMessage.info(`æŸ¥çœ‹è¯¦æƒ…ï¼š${content}`);
};

// å¼€å§‹ç»ƒä¹ 
const startPractice = content => {
  ElMessage.info(`å¼€å§‹ç»ƒä¹ ï¼š${content}`);
};

// éšæœºç»ƒä¹ é”™é¢˜
const randomPractice = () => {
  ElMessage.info('å¼€å§‹éšæœºç»ƒä¹ é”™é¢˜');
};

// ç­›é€‰é”™é¢˜
const filterWrong = type => {
  wrongFilter.value = type;
};

// è¿›å…¥å­¦ä¹ /ç»§ç»­å­¦ä¹ 
const enterChapter = chapter => {
  if (chapter.completion_status === 'NOT_STARTED') {
    ElMessage.warning('è¯¥ç« èŠ‚å°šæœªè§£é”');
    return;
  }
  ElMessage.info(`è¿›å…¥å­¦ä¹ ï¼š${chapter.chapter_name}`);
};

// ç« èŠ‚æµ‹è¯•
const chapterTest = chapter => {
  if (chapter.completion_status !== 'COMPLETED') {
    ElMessage.warning('è¯·å…ˆå®Œæˆè¯¥ç« èŠ‚çš„å­¦ä¹ ');
    return;
  }
  ElMessage.info(`å¼€å§‹æµ‹è¯•ï¼š${chapter.chapter_name}`);
};

// æŸ¥çœ‹ä½œä¸š/è€ƒè¯•è¯¦æƒ…
const viewTask = task => {
  ElMessage.info(`æŸ¥çœ‹è¯¦æƒ…ï¼š${task.title || task.exam_name}`);
};

// ==================== å‰ç«¯è¾…åŠ©å‡½æ•° START ====================
// è¿™äº›å‡½æ•°ç”¨äºå°†æ•°æ®åº“å­—æ®µæ ¼å¼åŒ–ä¸ºå‰ç«¯æ˜¾ç¤ºæ ¼å¼

// æ ¼å¼åŒ–å­¦ä¹ æ—¥å¿—çš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const formatLogDate = startTime => {
  const date = new Date(startTime);
  return `${date.getMonth() + 1}-${date
    .getDate()
    .toString()
    .padStart(2, '0')} å‘¨${'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[date.getDay()]}`;
};

const formatLogTime = startTime => {
  const date = new Date(startTime);
  return `${date.getHours().toString().padStart(2, '0')}:${date
    .getMinutes()
    .toString()
    .padStart(2, '0')}`;
};

const getLogTag = learningType => {
  const tagMap = {
    VIDEO: 'è§†é¢‘',
    MATERIAL: 'çŸ¥è¯†ç‚¹',
    EXERCISE: 'ç»ƒä¹ ',
    REVIEW: 'å¤ä¹ ',
  };
  return tagMap[learningType] || learningType;
};

// è·å–çŸ¥è¯†ç‚¹çŠ¶æ€ï¼ˆæ ¹æ®æŒæ¡ç‡ï¼‰
const getKnowledgeStatus = masteryRate => {
  if (masteryRate < 40)
    return { status: 'weak', color: '#ef4444', badge: 'è–„å¼±' };
  if (masteryRate < 60)
    return {
      status: 'normal',
      color: '#f59e0b',
      badge: masteryRate < 50 ? 'å¾…æå‡' : 'ä¸€èˆ¬',
    };
  return { status: 'good', color: '#22c55e', badge: 'è‰¯å¥½' };
};

// è·å–ç« èŠ‚çŠ¶æ€æ˜¾ç¤º
const getChapterStatusColor = completionStatus => {
  const colorMap = {
    COMPLETED: '#22c55e',
    IN_PROGRESS: '#f59e0b',
    NOT_STARTED: '#6b7280',
  };
  return colorMap[completionStatus] || '#6b7280';
};

const getChapterMeta = (knowledgePointCount, learningHours) => {
  return `${knowledgePointCount}ä¸ªçŸ¥è¯†ç‚¹ Â· é¢„è®¡å­¦ä¹ æ—¶é—´ ${learningHours}å°æ—¶`;
};

// æ ¼å¼åŒ–ä½œä¸šæˆªæ­¢æ—¶é—´ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const formatHomeworkDeadline = endTime => {
  const date = new Date(endTime);
  return `${date.getMonth() + 1}-${date
    .getDate()
    .toString()
    .padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date
    .getMinutes()
    .toString()
    .padStart(2, '0')}`;
};

// è·å–ä½œä¸šçŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const getHomeworkIcon = submissionStatus => {
  return submissionStatus === 'GRADED' || submissionStatus === 'RETURNED'
    ? 'âœ…'
    : 'ğŸ“‹';
};

const getHomeworkStatusText = submissionStatus => {
  return submissionStatus === 'GRADED' || submissionStatus === 'RETURNED'
    ? 'å·²å®Œæˆ'
    : 'è¿›è¡Œä¸­';
};

// æ ¼å¼åŒ–è€ƒè¯•æ—¶é—´ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const formatExamTime = (examDate, startTime, endTime) => {
  const date = new Date(examDate);
  const start = startTime.substring(0, 5); // HH:MM
  const end = endTime.substring(0, 5);
  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${start}-${end}`;
};

// è·å–è€ƒè¯•çŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const getExamIcon = totalScore => {
  return totalScore !== null ? 'âœ…' : 'ğŸ“‹';
};

const getExamStatusText = totalScore => {
  return totalScore !== null ? 'å·²å®Œæˆ' : 'å¾…è¯„åˆ†';
};

// ==================== å‰ç«¯è¾…åŠ©å‡½æ•° END ====================
</script>

<template>
  <div class="course-detail">
    <!-- æ±‰å ¡èœå•æŒ‰é’® - ä¾§è¾¹æ å…³é—­æ—¶æ˜¾ç¤º -->
    <MobileMenuToggle
      :is-open="sidebarOpen"
      :fixed="true"
      @toggle="toggleSidebar"
    />

    <!-- é®ç½©å±‚ -->
    <SidebarOverlay :is-show="sidebarOpen" @close="closeSidebar" />

    <!-- å·¦ä¾§è¾¹æ  -->
    <aside :class="['sidebar', { 'mobile-open': sidebarOpen }]">
      <div class="brand">è¯¾ç¨‹è¯¦æƒ…</div>
      <div class="sidebar-menu">
        <div
          :class="['menu-item', { active: activeView === 'learning' }]"
          @click="
            switchView('learning');
            closeSidebar();
          "
        >
          å­¦ä¹ è®°å½•
        </div>
        <div
          :class="['menu-item', { active: activeView === 'chapters' }]"
          @click="
            switchView('chapters');
            closeSidebar();
          "
        >
          ç« èŠ‚å†…å®¹
        </div>
        <div
          :class="['menu-item', { active: activeView === 'tasks' }]"
          @click="
            switchView('tasks');
            closeSidebar();
          "
        >
          è¯¾ç¨‹ä»»åŠ¡
        </div>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- é¡¶éƒ¨æ  -->
      <div class="topbar">
        <div class="breadcrumb">
          <a @click="goBack">è¿”å›</a>
          <span>/</span>
          <span class="current">{{ courseName }}</span>
          <span>Â·</span>
          <span>è¯¾ç¨‹è¯¦æƒ…</span>
        </div>

        <div class="topbar-actions">
          <el-button type="primary" size="small" @click="enterClassroom">
            è¿›å…¥è¯¾å ‚
          </el-button>
          <span style="color: #94a3b8; font-size: 12px"
            >å­¦å¹´å­¦æœŸ Â· ç¬¬ 2 å‘¨</span
          >
        </div>
      </div>

      <!-- å†…å®¹åŒºåŸŸ -->
      <div class="content-area">
        <!-- å­¦ä¹ è®°å½•è§†å›¾ -->
        <div v-show="activeView === 'learning'" class="panel">
          <div class="panel-title">ğŸ“š å­¦ä¹ è®°å½•</div>

          <!-- äºŒçº§Tab -->
          <div class="sub-tabs">
            <div
              :class="['sub-tab', { active: activeLearningTab === 'log' }]"
              @click="activeLearningTab = 'log'"
            >
              å­¦ä¹ æ—¥å¿—
            </div>
            <div
              :class="['sub-tab', { active: activeLearningTab === 'profile' }]"
              @click="activeLearningTab = 'profile'"
            >
              å­¦ä¹ ç”»åƒ
            </div>
            <div
              :class="['sub-tab', { active: activeLearningTab === 'wrong' }]"
              @click="activeLearningTab = 'wrong'"
            >
              é”™é¢˜è®°å½•
            </div>
          </div>

          <!-- å­¦ä¹ æ—¥å¿— -->
          <div v-show="activeLearningTab === 'log'">
            <div
              v-for="log in learningLogs"
              :key="log.record_id"
              class="log-item"
            >
              <div class="log-date">{{ formatLogDate(log.start_time) }}</div>
              <div class="log-card">
                <div class="log-time">{{ formatLogTime(log.start_time) }}</div>
                <div class="log-tag">{{ getLogTag(log.learning_type) }}</div>
                <div>{{ log.content_title }}</div>
              </div>
              <el-button
                v-if="
                  log.learning_type === 'MATERIAL' ||
                  log.learning_type === 'VIDEO'
                "
                type="primary"
                size="small"
                @click="viewKnowledge(log.content_title)"
              >
                ğŸ“š æŸ¥çœ‹è¯¦æƒ…
              </el-button>
              <el-button
                v-else
                type="success"
                size="small"
                @click="startPractice(log.content_title)"
              >
                ğŸ’ª å¼€å§‹ç»ƒä¹ 
              </el-button>
            </div>
          </div>

          <!-- å­¦ä¹ ç”»åƒ -->
          <div v-show="activeLearningTab === 'profile'">
            <div class="knowledge-grid">
              <div
                v-for="point in knowledgePoints"
                :key="point.point_id"
                :class="[
                  'knowledge-card',
                  getKnowledgeStatus(point.mastery_rate).status,
                ]"
              >
                <div class="knowledge-header">
                  <div class="knowledge-name">{{ point.point_name }}</div>
                  <span
                    class="knowledge-badge"
                    :style="{
                      background: getKnowledgeStatus(point.mastery_rate).color,
                    }"
                  >
                    {{ getKnowledgeStatus(point.mastery_rate).badge }}
                  </span>
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    :style="{
                      width: point.mastery_rate + '%',
                      background: getKnowledgeStatus(point.mastery_rate).color,
                    }"
                  ></div>
                </div>
                <div style="font-weight: 600; margin-bottom: 6px">
                  {{ point.mastery_rate }}%
                </div>
                <div
                  style="font-size: 12px; color: #6b7280; margin-bottom: 8px"
                >
                  éš¾åº¦ç­‰çº§ï¼š{{ point.difficulty_level }} | é‡è¦åº¦ï¼š{{
                    point.importance_level
                  }}
                </div>
                <el-button
                  size="small"
                  :type="
                    getKnowledgeStatus(point.mastery_rate).status === 'good'
                      ? 'success'
                      : 'warning'
                  "
                  style="width: 100%"
                >
                  {{
                    getKnowledgeStatus(point.mastery_rate).status === 'good'
                      ? 'âœ¨ ä¿æŒæ°´å¹³'
                      : 'ğŸ”¥ ä¸“é¡¹çªç ´'
                  }}
                </el-button>
              </div>
            </div>
          </div>

          <!-- é”™é¢˜è®°å½• -->
          <div v-show="activeLearningTab === 'wrong'">
            <div class="wrong-header">
              <div style="color: #6b7280">
                å…±æ‰¾åˆ°
                <span style="font-weight: 600">{{
                  filteredWrongQuestions.length
                }}</span>
                é“é”™é¢˜
              </div>
              <el-button type="primary" size="small" @click="randomPractice">
                éšæœºç»ƒä¹ 
              </el-button>
            </div>

            <div class="filter-buttons">
              <div
                :class="['filter-btn', { active: wrongFilter === 'all' }]"
                @click="filterWrong('all')"
              >
                å…¨éƒ¨
              </div>
              <div
                :class="['filter-btn', { active: wrongFilter === 'choice' }]"
                @click="filterWrong('choice')"
              >
                é€‰æ‹©é¢˜
              </div>
              <div
                :class="['filter-btn', { active: wrongFilter === 'fill' }]"
                @click="filterWrong('fill')"
              >
                å¡«ç©ºé¢˜
              </div>
              <div
                :class="[
                  'filter-btn',
                  { active: wrongFilter === 'calculation' },
                ]"
                @click="filterWrong('calculation')"
              >
                è®¡ç®—é¢˜
              </div>
            </div>

            <div
              v-for="q in filteredWrongQuestions"
              :key="q.wrong_id"
              class="wrong-card"
            >
              <div class="wrong-question">{{ q.question_text }}</div>
              <div class="wrong-answer">
                ä½ çš„ç­”æ¡ˆï¼š{{ q.wrong_answer }}ï¼›æ­£ç¡®ç­”æ¡ˆï¼š{{ q.correct_answer }}
              </div>
              <div class="wrong-tip">ğŸ’¡ æç¤ºï¼š{{ q.analysis }}</div>
            </div>
          </div>
        </div>

        <!-- ç« èŠ‚å†…å®¹è§†å›¾ -->
        <div v-show="activeView === 'chapters'" class="panel">
          <div class="panel-title">ğŸ“– ç« èŠ‚å†…å®¹</div>

          <div
            v-for="chapter in chapters"
            :key="chapter.chapter_id"
            class="chapter-card"
          >
            <div class="chapter-header">
              <div
                class="chapter-number"
                :style="{
                  background: getChapterStatusColor(chapter.completion_status),
                }"
              >
                {{ chapter.chapter_no }}
              </div>
              <div class="chapter-info">
                <div class="chapter-title">{{ chapter.chapter_name }}</div>
                <div class="chapter-meta">
                  {{
                    getChapterMeta(
                      chapter.knowledge_point_count,
                      chapter.learning_hours
                    )
                  }}
                </div>
              </div>
              <el-tag
                v-if="chapter.completion_status === 'COMPLETED'"
                type="success"
                size="small"
              >
                å·²å®Œæˆ
              </el-tag>
              <el-tag
                v-else-if="chapter.completion_status === 'IN_PROGRESS'"
                type="warning"
                size="small"
              >
                å­¦ä¹ ä¸­
              </el-tag>
              <el-tag v-else type="info" size="small">æœªå¼€å§‹</el-tag>
            </div>
            <div class="chapter-content">{{ chapter.learning_objectives }}</div>
            <div style="display: flex; gap: 8px">
              <el-button
                type="primary"
                size="small"
                :disabled="chapter.completion_status === 'NOT_STARTED'"
                @click="enterChapter(chapter)"
              >
                {{
                  chapter.completion_status === 'IN_PROGRESS'
                    ? 'ç»§ç»­å­¦ä¹ '
                    : 'è¿›å…¥å­¦ä¹ '
                }}
              </el-button>
              <el-button
                size="small"
                :disabled="chapter.completion_status !== 'COMPLETED'"
                @click="chapterTest(chapter)"
              >
                ç« èŠ‚æµ‹è¯•
              </el-button>
            </div>
          </div>
        </div>

        <!-- è¯¾ç¨‹ä»»åŠ¡è§†å›¾ -->
        <div v-show="activeView === 'tasks'" class="panel">
          <div class="panel-title">ğŸ“‹ è¯¾ç¨‹ä»»åŠ¡</div>

          <!-- äºŒçº§Tab -->
          <div class="sub-tabs">
            <div
              :class="['sub-tab', { active: activeTaskTab === 'homework' }]"
              @click="activeTaskTab = 'homework'"
            >
              ä½œä¸š
            </div>
            <div
              :class="['sub-tab', { active: activeTaskTab === 'exam' }]"
              @click="activeTaskTab = 'exam'"
            >
              è€ƒè¯•
            </div>
          </div>

          <!-- ä½œä¸š -->
          <div v-show="activeTaskTab === 'homework'">
            <div
              v-for="hw in homeworks"
              :key="hw.assignment_id"
              class="task-card"
              @click="viewTask(hw)"
            >
              <div class="task-row">
                <div class="task-icon">
                  {{ getHomeworkIcon(hw.submission_status) }}
                </div>
                <div class="task-info">
                  <div class="task-title">{{ hw.title }}</div>
                  <div class="task-time">
                    æˆªæ­¢ï¼š{{ formatHomeworkDeadline(hw.end_time) }} |
                    {{ hw.total_score }}åˆ†
                  </div>
                </div>
                <div
                  :class="[
                    'task-status',
                    hw.submission_status === 'NOT_SUBMITTED' ||
                    hw.submission_status === 'SUBMITTED'
                      ? 'status-pending'
                      : 'status-completed',
                  ]"
                >
                  {{ getHomeworkStatusText(hw.submission_status) }}
                </div>
              </div>
            </div>
          </div>

          <!-- è€ƒè¯• -->
          <div v-show="activeTaskTab === 'exam'">
            <div
              v-for="exam in exams"
              :key="exam.arrangement_id"
              class="task-card"
              @click="viewTask(exam)"
            >
              <div class="task-row">
                <div class="task-icon">{{ getExamIcon(exam.total_score) }}</div>
                <div class="task-info">
                  <div class="task-title">{{ exam.exam_name }}</div>
                  <div class="task-time">
                    è€ƒè¯•æ—¶é—´ï¼š{{
                      formatExamTime(
                        exam.exam_date,
                        exam.start_time,
                        exam.end_time
                      )
                    }}
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px">
                  <div
                    :class="[
                      'task-status',
                      exam.total_score !== null
                        ? 'status-completed'
                        : 'status-pending',
                    ]"
                  >
                    {{ getExamStatusText(exam.total_score) }}
                  </div>
                  <div
                    v-if="exam.total_score !== null"
                    style="font-weight: 600"
                  >
                    {{ exam.total_score }}åˆ†
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>
